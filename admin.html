<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Cultura RPG</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/login.css">
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-container">
                <h1 class="logo">Cultura RPG - Admin</h1>
            </div>
        </nav>
    </header>

    <main>
        <div class="login-container">
            <div class="login-card">
                <h2>Painel Administrativo</h2>
                
                <div class="admin-actions">
                    <div id="auth-status" class="message">Verificando autenticação...</div>
                    
                    <div id="login-section" style="display: none;">
                        <h3>Faça login primeiro:</h3>
                        <form id="admin-login">
                            <input type="email" id="admin-email" placeholder="Email" required>
                            <input type="password" id="admin-password" placeholder="Senha" required>
                            <button type="submit" class="auth-btn">Entrar</button>
                        </form>
                    </div>
                    
                    <div id="admin-buttons" style="display: none;">
                        <button onclick="testConnection()" class="auth-btn">
                            Testar Conexão
                        </button>
                        
                        <button onclick="initPersonagens()" class="auth-btn">
                            Salvar Personagem Teste
                        </button>
                        
                        <button onclick="initDatabase()" class="auth-btn">
                            Inicializar Banco Completo
                        </button>
                    </div>
                    
                    <div id="admin-message" class="message"></div>
                    
                    <div class="admin-info">
                        <h3>Ações Disponíveis:</h3>
                        <ul>
                            <li><strong>Inicializar Banco:</strong> Popula o Firebase com personagens e missões iniciais</li>
                            <li><strong>Adicionar Personagens:</strong> Use o console do Firebase para adicionar novos personagens</li>
                            <li><strong>Gerenciar Missões:</strong> Edite missões diretamente no Firebase Database</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { auth } from './js/firebase-config.js';
        import { signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { initializeDatabase } from './js/init-database.js';
        import { testConnection, initPersonagens } from './js/simple-init.js';
        
        let currentUser = null;
        
        // Verificar autenticação
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateAuthUI();
        });
        
        function updateAuthUI() {
            const authStatus = document.getElementById('auth-status');
            const loginSection = document.getElementById('login-section');
            const adminButtons = document.getElementById('admin-buttons');
            
            if (currentUser) {
                authStatus.textContent = `Logado como: ${currentUser.email}`;
                authStatus.className = 'message success';
                authStatus.style.display = 'block';
                loginSection.style.display = 'none';
                adminButtons.style.display = 'block';
            } else {
                authStatus.textContent = 'Você precisa fazer login para acessar o painel admin.';
                authStatus.className = 'message error';
                authStatus.style.display = 'block';
                loginSection.style.display = 'block';
                adminButtons.style.display = 'none';
            }
        }
        
        // Login admin
        document.getElementById('admin-login').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage('Login realizado com sucesso!', 'success');
            } catch (error) {
                showMessage('Erro no login: ' + error.message, 'error');
            }
        });
        
        function showMessage(text, type = 'success') {
            const messageEl = document.getElementById('admin-message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }
        
        window.initDatabase = async () => {
            if (!currentUser) {
                showMessage('Faça login primeiro!', 'error');
                return;
            }
            try {
                showMessage('Inicializando banco de dados...', 'success');
                await initializeDatabase();
                showMessage('Banco de dados inicializado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro completo:', error);
                showMessage('Erro: ' + (error.message || 'Erro desconhecido'), 'error');
                
                // Mostrar detalhes do erro no console
                if (error.code) {
                    console.error('Código Firebase:', error.code);
                }
            }
        };
        
        window.testConnection = async () => {
            if (!currentUser) {
                showMessage('Faça login primeiro!', 'error');
                return;
            }
            try {
                showMessage('Testando conexão...', 'success');
                await testConnection();
                showMessage('Conexão OK!', 'success');
            } catch (error) {
                showMessage('Erro na conexão: ' + error.message, 'error');
            }
        };
        
        window.initPersonagens = async () => {
            if (!currentUser) {
                showMessage('Faça login primeiro!', 'error');
                return;
            }
            try {
                showMessage('Salvando personagem teste...', 'success');
                await initPersonagens();
                showMessage('Personagem teste salvo!', 'success');
            } catch (error) {
                showMessage('Erro: ' + error.message, 'error');
            }
        };
    </script>
</body>
</html>